<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="/public/css/playlist-detail.css">
</head>
<body>
  <!-- Audio Visualizer -->
  <div class="audio-visualizer" id="visualizer">
    <div class="bar"></div>
    <div class="bar"></div>
    <div class="bar"></div>
    <div class="bar"></div>
    <div class="bar"></div>
    <div class="bar"></div>
    <div class="bar"></div>
    <div class="bar"></div>
    <div class="bar"></div>
    <div class="bar"></div>
    <div class="bar"></div>
    <div class="bar"></div>
    <div class="bar"></div>
    <div class="bar"></div>
    <div class="bar"></div>
    <div class="bar"></div>
    <div class="bar"></div>
    <div class="bar"></div>
    <div class="bar"></div>
    <div class="bar"></div>
  </div>

  <header class="header">
    <div style="display: flex; align-items: center;">
      <div class="logo">
        <img src="/public/img/saoclao.png" alt="SAOCLAO">
      </div>
      <nav class="nav-menu">
        <a href="/profile" class="nav-link">
          <i class="fa-solid fa-house"></i> Home
        </a>
        <a href="/playlists" class="nav-link active">
          <i class="fa-solid fa-music"></i> My playlists
        </a>
        <a href="/likes" class="nav-link">
          <i class="fa-solid fa-heart"></i> Liked
        </a>
      </nav>
    </div>
    <div class="header-actions">
      <div class="user-avatar" onclick="window.location.href='/users/<%= user.username %>'">
        <%= user.username.charAt(0).toUpperCase() %>
      </div>
      <form method="post" action="/logout" style="display:inline">
        <button type="submit" class="btn-logout">Log out</button>
      </form>
    </div>
  </header>
  
  <div class="playlist-hero">
    <div class="playlist-cover">
      <% 
        const covers = playlist.tracks.slice(0, 4).map(t => t.coverUrl).filter(Boolean);
      %>
      <% if (covers.length === 0) { %>
        <div class="playlist-cover-empty">
          <i class="fa-solid fa-music"></i>
        </div>
      <% } else if (covers.length === 1) { %>
        <div class="playlist-cover-item" style="background-image: url('<%= covers[0] %>'); width: 100%; height: 100%;"></div>
      <% } else { %>
        <div class="playlist-cover-grid">
          <% for (let i = 0; i < 4; i++) { %>
            <% if (covers[i]) { %>
              <div class="playlist-cover-item" style="background-image: url('<%= covers[i] %>');"></div>
            <% } else { %>
              <div class="playlist-cover-item"></div>
            <% } %>
          <% } %>
        </div>
      <% } %>
    </div>
    <div class="playlist-info">
      <div class="playlist-type">Playlist</div>
      <h1 class="playlist-name"><%= playlist.name %></h1>
      <div class="playlist-meta">
        <span><i class="fa-solid fa-user"></i> <%= playlist.userId?.username || user.username %></span>
        <span>â€¢</span>
        <span><i class="fa-solid fa-music"></i> <%= playlist.tracks.length %> tracks</span>
      </div>
      <div class="playlist-badge <%= playlist.isPublic ? 'public' : '' %>">
        <%= playlist.isPublic ? 'Public' : 'Private' %>
      </div>
      <% if (playlist.description) { %>
        <div class="playlist-description"><%= playlist.description %></div>
      <% } %>
    </div>
  </div>
  
  <div class="playlist-actions">
    <% if (playlist.tracks.length > 0) { %>
      <button class="btn-play-all" onclick="playAll()">
        <i class="fa-solid fa-play"></i>
      </button>
      <button class="btn-play-all" onclick="shufflePlay()" style="background: transparent; border: 2px solid var(--accent); color: var(--accent);" title="Shuffle play">
        <i class="fa-solid fa-shuffle"></i>
      </button>
    <% } %>
    <% if (isOwner) { %>
      <button class="btn-action" onclick="toggleVisibility(this)" title="Toggle visibility">
        <i class="fa-solid fa-earth-americas"></i>
      </button>
    <% } %>
    <% if (playlist.isPublic) { %>
      <button class="btn-action" onclick="copyShareLink()" title="Copy share link">
        <i class="fa-solid fa-link"></i>
      </button>
    <% } %>
    <button class="btn-action" onclick="window.history.back()" title="Go back">
      <i class="fa-solid fa-arrow-left"></i>
    </button>
    <% if (isOwner) { %>
      <button class="btn-action" onclick="deletePlaylist()" title="Delete playlist">
        <i class="fa-solid fa-trash"></i>
      </button>
    <% } %>
  </div>
  
  <div class="tracks-container">
    <% if (playlist.tracks && playlist.tracks.length > 0) { %>
      <div class="track-header">
        <div>#</div>
        <div>Song title</div>
        <div>Duration</div>
        <div></div>
      </div>
      <div class="track-list">
        <% playlist.tracks.forEach((track, index) => { %>
          <div class="track-item" data-track-id="<%= track._id %>">
            <div class="track-number"><%= index + 1 %></div>
            <div class="track-info">
              <div class="track-thumb">
                <% if (track.coverUrl) { %>
                  <img src="<%= track.coverUrl %>" alt="<%= track.title %>">
                <% } %>
              </div>
              <div class="track-details">
                <div class="track-title"><%= track.title %></div>
                <div class="track-artist">
                  <% if (track.uploadedBy && track.uploadedBy.username) { %>
                    <a href="/users/<%= track.uploadedBy.username %>"><%= track.artist || track.uploadedBy.username %></a>
                  <% } else { %>
                    <%= track.artist || 'Unknown Artist' %>
                  <% } %>
                </div>
              </div>
            </div>
            <div class="track-duration">--:--</div>
            <div class="track-actions">
              <button class="btn-track-action" 
                      onclick="window.playTrack('<%= track._id %>', '<%= track.title.replace(/'/g, "\\'") %>', '<%= (track.artist || 'Unknown').replace(/'/g, "\\'") %>', '<%= track.coverUrl || '' %>', '<%= track.audioUrl %>')" 
                      title="Play">
                <i class="fa-solid fa-play"></i>
              </button>
              <% if (isOwner) { %>
                <button class="btn-track-action" onclick="removeTrack('<%= track._id %>')" title="Remove">
                  <i class="fa-solid fa-xmark"></i>
                </button>
              <% } %>
            </div>
          </div>
        <% }) %>
      </div>
    <% } else { %>
      <div class="empty-state">
        <i class="fa-solid fa-music"></i>
        <h3>Empty playlist</h3>
        <p>Add songs to your playlist</p>
      </div>
    <% } %>
  </div>
  
  <!-- Queue Panel -->
  <div class="queue-panel" id="queuePanel">
    <div class="queue-header">
      <h3 class="queue-title">Queue</h3>
      <button class="queue-clear" onclick="player.clearQueue()">Clear all</button>
    </div>
    <div class="queue-list" id="queueList"></div>
  </div>
  
  <!-- Music Player -->
  <div class="music-player" id="musicPlayer">
    <div class="player-wrapper">
      <div class="player-left">
        <div class="player-thumb" id="playerThumb"></div>
        <div class="player-info">
          <div class="player-title" id="playerTitle">Song title</div>
          <div class="player-artist" id="playerArtist">Artist</div>
        </div>
      </div>
      
      <div class="player-center">
        <div class="player-buttons">
          <button class="control-btn" id="shuffleBtn" title="Shuffle">
            <i class="fa-solid fa-shuffle"></i>
          </button>
          <button class="control-btn" id="prevBtn" title="Previous">
            <i class="fa-solid fa-backward-step"></i>
          </button>
          <button class="control-btn play" id="playPauseBtn">
            <i class="fa-solid fa-play"></i>
          </button>
          <button class="control-btn" id="nextBtn" title="Next">
            <i class="fa-solid fa-forward-step"></i>
          </button>
          <button class="control-btn" id="repeatBtn" title="Repeat">
            <i class="fa-solid fa-repeat"></i>
          </button>
        </div>
        <div class="player-progress-wrapper">
          <span class="time" id="currentTime">0:00</span>
          <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <span class="time" id="duration">0:00</span>
        </div>
      </div>
      
      <div class="player-right">
        <div class="volume-control">
          <i class="fa-solid fa-volume-high volume-icon" id="volumeIcon"></i>
          <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="70">
        </div>
        <button class="queue-toggle" id="queueBtn" title="Queue">
          <i class="fa-solid fa-list"></i>
          <span class="queue-count" id="queueCount">0</span>
        </button>
      </div>
    </div>
  </div>
  
  <audio id="audioPlayer"></audio>
  
  <script src="/public/js/player.js"></script>
  <script>
    // Wait for player to initialize
    window.addEventListener('DOMContentLoaded', () => {
      console.log('Playlist detail page loaded');
      
      // Load durations for all tracks
      loadTrackDurations();
      
      // Check player initialization
      const checkPlayer = setInterval(() => {
        if (window.player) {
          console.log('Player ready on playlist detail page');
          clearInterval(checkPlayer);
          
          // Update playing state after player is ready
          setTimeout(() => {
            updatePlayingState();
          }, 500);
        }
      }, 100);
      
      // Stop checking after 5 seconds
      setTimeout(() => clearInterval(checkPlayer), 5000);
    });
    
    // Load duration for all tracks
    function loadTrackDurations() {
      const trackItems = document.querySelectorAll('.track-item');
      
      trackItems.forEach((item, index) => {
        const durationElement = item.querySelector('.track-duration');
        const trackData = [
          <% playlist.tracks.forEach((track, index) => { %>
            {
              audioUrl: '<%= track.audioUrl %>',
              index: <%= index %>
            }<%= index < playlist.tracks.length - 1 ? ',' : '' %>
          <% }) %>
        ][index];
        
        if (trackData && trackData.audioUrl) {
          loadDuration(trackData.audioUrl, durationElement);
        }
      });
    }
    
    // Load duration for a single track
    function loadDuration(audioUrl, element) {
      const audio = new Audio();
      
      audio.addEventListener('loadedmetadata', () => {
        const duration = audio.duration;
        if (duration && !isNaN(duration)) {
          element.textContent = formatTime(duration);
        }
      });
      
      audio.addEventListener('error', () => {
        element.textContent = '--:--';
      });
      
      audio.src = audioUrl;
    }
    
    // Format time helper
    function formatTime(seconds) {
      if (!seconds || isNaN(seconds)) return '--:--';
      
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    // Visualizer Animation
    function animateVisualizer() {
      const bars = document.querySelectorAll('.bar');
      const audio = document.getElementById('audioPlayer');
      
      function updateBars() {
        if (audio && !audio.paused) {
          bars.forEach((bar, i) => {
            const height = Math.random() * 80 + 20;
            bar.style.height = height + 'px';
          });
        } else {
          bars.forEach(bar => {
            bar.style.height = '20px';
          });
        }
        requestAnimationFrame(updateBars);
      }
      
      updateBars();
    }
    
    animateVisualizer();
    
    // Play All Function
    function playAll() {
      if (!window.player) {
        alert('Player is not ready');
        return;
      }
      
      const tracks = [
        <% playlist.tracks.forEach((track, index) => { %>
          {
            id: '<%= track._id %>',
            title: '<%= track.title.replace(/'/g, "\\'") %>',
            artist: '<%= (track.artist || 'Unknown').replace(/'/g, "\\'") %>',
            cover: '<%= track.coverUrl || '' %>',
            audioUrl: '<%= track.audioUrl %>'
          }<%= index < playlist.tracks.length - 1 ? ',' : '' %>
        <% }) %>
      ];
      
      if (tracks.length > 0) {
        window.player.queue = tracks;
        window.player.originalQueue = [...tracks];
        window.player.queueIndex = 0;
        window.player.playTrack(tracks[0]);
        window.player.renderQueue();
        window.player.saveState();
        
        setTimeout(updatePlayingState, 300);
      }
    }
    
    // Shuffle Play Function
    function shufflePlay() {
      if (!window.player) {
        alert('Player is not ready');
        return;
      }
      
      const tracks = [
        <% playlist.tracks.forEach((track, index) => { %>
          {
            id: '<%= track._id %>',
            title: '<%= track.title.replace(/'/g, "\\'") %>',
            artist: '<%= (track.artist || 'Unknown').replace(/'/g, "\\'") %>',
            cover: '<%= track.coverUrl || '' %>',
            audioUrl: '<%= track.audioUrl %>'
          }<%= index < playlist.tracks.length - 1 ? ',' : '' %>
        <% }) %>
      ];
      
      if (tracks.length > 0) {
        // Shuffle array
        const shuffled = tracks.sort(() => Math.random() - 0.5);
        
        window.player.queue = shuffled;
        window.player.originalQueue = [...tracks];
        window.player.queueIndex = 0;
        window.player.isShuffled = true;
        window.player.playTrack(shuffled[0]);
        
        if (window.player.shuffleBtn) {
          window.player.shuffleBtn.classList.add('active');
        }
        
        window.player.renderQueue();
        window.player.saveState();
        
        setTimeout(updatePlayingState, 300);
      }
    }
    
    // Play Single Track
    window.playTrack = function(id, title, artist, cover, audioUrl) {
      if (!window.player) {
        alert('Player is not ready');
        return;
      }
      
      const track = { id, title, artist, cover, audioUrl };
      window.player.playTrack(track);
      
      // Update UI
      setTimeout(updatePlayingState, 300);
    };
    
    // Remove Track from Playlist
    async function removeTrack(trackId) {
      if (!confirm('Are you sure you want to remove this song from the playlist?')) {
        return;
      }
      
      try {
        const res = await fetch('/playlists/<%= playlist._id %>/remove-track', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ trackId })
        });
        
        const data = await res.json();
        
        if (data.success) {
          location.reload();
        } else {
          alert(data.message || 'Failed to remove song');
        }
      } catch (err) {
        console.error(err);
        alert('An error occurred');
      }
    }
    
    // Delete Playlist
    async function deletePlaylist() {
      if (!confirm('Are you sure you want to delete this playlist? This cannot be undone.')) {
        return;
      }
      
      try {
        const res = await fetch('/playlists/<%= playlist._id %>/delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await res.json();
        
        if (data.success) {
          window.location.href = '/playlists';
        } else {
          alert(data.message || 'Failed to delete playlist');
        }
      } catch (err) {
        console.error(err);
        alert('An error occurred');
      }
    }

    async function toggleVisibility(btn) {
      try {
        const nextState = !<%= playlist.isPublic ? 'true' : 'false' %>;
        const res = await fetch('/playlists/<%= playlist._id %>/visibility', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ isPublic: nextState })
        });
        const data = await res.json();
        if (data.success) {
          alert(data.isPublic ? 'Switched to public' : 'Switched to private');
          location.reload();
        } else {
          alert(data.message || 'Could not update visibility');
        }
      } catch (err) {
        console.error(err);
        alert('An error occurred');
      }
    }

    function copyShareLink() {
      const link = window.location.origin + '/playlists/<%= playlist._id %>';
      navigator.clipboard.writeText(link).then(() => {
        alert('Copied share link');
      }).catch(() => alert('Could not copy link'));
    }
    
    // Update Playing State
    function updatePlayingState() {
      if (!window.player || !window.player.currentTrack) {
        return;
      }
      
      console.log('Updating playing state for:', window.player.currentTrack.id);
      
      // Remove all playing states
      document.querySelectorAll('.track-item').forEach(item => {
        item.classList.remove('playing');
      });
      
      // Add playing state to current track
      const currentTrackId = window.player.currentTrack.id;
      const currentItem = document.querySelector(`.track-item[data-track-id="${currentTrackId}"]`);
      if (currentItem) {
        currentItem.classList.add('playing');
        console.log('Track marked as playing:', currentTrackId);
      }
    }
    
    // Listen to player events
    const audio = document.getElementById('audioPlayer');
    if (audio) {
      audio.addEventListener('play', () => {
        console.log('Audio started playing');
        updatePlayingState();
      });
      
      audio.addEventListener('pause', () => {
        console.log('Audio paused');
        updatePlayingState();
      });
      
      audio.addEventListener('ended', updatePlayingState);
    }
    
    // Periodic update to sync state
    setInterval(() => {
      if (window.player && window.player.currentTrack) {
        updatePlayingState();
      }
    }, 2000);
    
    // Queue toggle
    document.getElementById('queueBtn')?.addEventListener('click', () => {
      document.getElementById('queuePanel').classList.toggle('active');
    });
  </script>
</body>
</html>

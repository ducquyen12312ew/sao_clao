<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title || 'Upload - SAOCLAO' %></title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/public/css/upload.css">

</head>
<body>
  <header class="header">
    <a class="logo-link" href="/">
      <img src="/public/img/saoclao.png" alt="SAOCLAO" class="logo-img">
    </a>
  </header>
  
  <% if (flash) { %>
    <div class="flash <%= flash.type %>"><%= flash.message %></div>
    <script>setTimeout(() => document.querySelector('.flash').remove(), 3000);</script>
  <% } %>
  
  <main class="container">
    <div class="page-header">
      <h1>Upload your track</h1>
      <p>For best quality, use WAV, FLAC, AIFF, or ALAC. Maximum size 4GB.</p>
    </div>
    
    <div class="upload-box" id="uploadBox">
      <div class="upload-icon">
        <svg viewBox="0 0 80 80">
          <path d="M40,10 C23,10 10,23 10,40 C10,57 23,70 40,70 C57,70 70,57 70,40 C70,23 57,10 40,10 Z M40,50 L30,40 L35,40 L35,30 L45,30 L45,40 L50,40 Z"/>
        </svg>
      </div>
      <div class="upload-text">
        <h3>Drag and drop your audio here to start</h3>
        <p>or</p>
      </div>
      <input type="file" id="audioFile" class="file-input" accept=".mp3,.wav,audio/*">
      <button class="choose-btn" onclick="document.getElementById('audioFile').click()">
        Choose file
      </button>
    </div>
    
    <form method="post" action="/upload/new" enctype="multipart/form-data" id="detailsForm" class="details-form">
      <input type="file" name="audio" id="hiddenAudio" style="display:none;">
      
      <div class="audio-info" id="audioInfo" style="display:none;">
        <div class="icon">ðŸŽµ</div>
        <div class="details">
          <div class="filename" id="audioName"></div>
          <div class="filesize" id="audioSize"></div>
        </div>
      </div>

      <div class="ai-box">
        <div>
          <h3 class="ai-title">AI song ideas</h3>
          <p class="ai-desc">Enter an idea, pick a style, and let AI write lyrics.</p>
        </div>
        <div class="form-group">
          <label>Idea / prompt</label>
          <input type="text" id="aiPrompt" placeholder="Ex: A rainy afternoon missing an old love">
        </div>
        <div class="form-row">
          <div class="form-group half">
            <label>Genre</label>
            <input type="text" id="aiGenre" placeholder="ballad, pop, rap...">
          </div>
          <div class="form-group half">
            <label>Mood</label>
            <input type="text" id="aiMood" placeholder="bright, mellow...">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group half">
            <label>Melody / vibe</label>
            <input type="text" id="aiVibe" placeholder="chill, upbeat, cinematic...">
          </div>
          <div class="form-group half">
            <label>Vocal tone</label>
            <input type="text" id="aiVocal" placeholder="high male, low female...">
          </div>
        </div>
        <div class="form-group">
          <label>Desired length</label>
          <input type="text" id="aiLength" placeholder="Short, medium, long">
        </div>
        <div class="ai-actions">
          <button type="button" class="btn btn-secondary" id="aiFillDemo">Paste demo</button>
          <button type="button" class="btn btn-primary" id="aiGenerate">Generate lyrics with AI</button>
          <div id="aiStatus" class="ai-status" style="display:none;">Generating...</div>
        </div>
      </div>
      
      <div class="form-group">
        <label>Song title <span class="required">*</span></label>
        <input type="text" name="title" required placeholder="Enter song title">
      </div>
      
      <div class="form-group">
        <label>Artist</label>
        <input type="text" name="artist" placeholder="Artist name">
      </div>

      <div class="form-row">
        <div class="form-group half">
          <label>Genre</label>
          <input type="text" name="genres" placeholder="VD: pop, indie, lo-fi">
          <small class="form-hint">Enter multiple values separated by commas</small>
        </div>
        <div class="form-group half">
          <label>Tags</label>
          <input type="text" name="tags" placeholder="VD: chill, study, workout">
          <small class="form-hint">Enter multiple values separated by commas</small>
        </div>
      </div>

      <div class="form-group">
        <label>Mood</label>
        <input type="text" name="mood" placeholder="VD: happy, sad, energetic">
      </div>

      <div class="form-group">
        <label>Lyrics (text)</label>
        <textarea name="lyricsText" rows="4" placeholder="Enter lyrics in plain text"></textarea>
      </div>

      <div class="form-group">
        <label>Lyrics (LRC)</label>
        <textarea name="lyricsLRC" rows="4" placeholder="[00:12.00] Line 1&#10;[00:25.50] Line 2"></textarea>
        <small class="form-hint">Optional, supports karaoke-style sync</small>
      </div>
      
      <div class="form-group">
        <label>Cover image</label>
        <div class="image-upload">
          <div class="image-preview empty" id="imagePreview">ðŸ–¼</div>
          <div class="image-info">
            <p>PNG or JPG, recommended 3000x3000px.<br>Up to 5MB.</p>
            <input type="file" name="cover" id="coverFile" accept="image/*" style="display:none;">
            <button type="button" class="image-btn" onclick="document.getElementById('coverFile').click()">
              Choose image
            </button>
          </div>
        </div>
      </div>
      
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="window.location.href='/'">Cancel</button>
        <button type="submit" class="btn btn-primary">Upload</button>
      </div>
    </form>
  </main>
  
  <script>
    const audioFile = document.getElementById('audioFile');
    const hiddenAudio = document.getElementById('hiddenAudio');
    const uploadBox = document.getElementById('uploadBox');
    const detailsForm = document.getElementById('detailsForm');
    const audioInfo = document.getElementById('audioInfo');
    const coverFile = document.getElementById('coverFile');
    const imagePreview = document.getElementById('imagePreview');
    
    audioFile.addEventListener('change', handleAudio);
    
    uploadBox.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadBox.classList.add('dragover');
    });

    uploadBox.addEventListener('dragleave', () => {
      uploadBox.classList.remove('dragover');
    });

    uploadBox.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadBox.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files[0]?.type.startsWith('audio/')) {
        audioFile.files = files;
        handleAudio();
      }
    });
    
    function handleAudio() {
      const file = audioFile.files[0];
      if (file) {
        const dt = new DataTransfer();
        dt.items.add(file);
        hiddenAudio.files = dt.files;
        
        uploadBox.style.display = 'none';
        detailsForm.classList.add('active');
        audioInfo.style.display = 'flex';
        document.getElementById('audioName').textContent = file.name;
        document.getElementById('audioSize').textContent = (file.size / 1024 / 1024).toFixed(1) + ' MB';
      }
    }
    
    coverFile.addEventListener('change', function() {
      const file = this.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          imagePreview.innerHTML = `<img src="${e.target.result}">`;
          imagePreview.classList.remove('empty');
        };
        reader.readAsDataURL(file);
      }
    });

    // AI helper
    const aiBtn = document.getElementById('aiGenerate');
    const aiStatus = document.getElementById('aiStatus');
    const aiPrompt = document.getElementById('aiPrompt');
    const aiGenre = document.getElementById('aiGenre');
    const aiMood = document.getElementById('aiMood');
    const aiVibe = document.getElementById('aiVibe');
    const aiVocal = document.getElementById('aiVocal');
    const aiLength = document.getElementById('aiLength');
    const aiFillDemo = document.getElementById('aiFillDemo');

    aiFillDemo?.addEventListener('click', () => {
      aiPrompt.value = 'A young person reminiscing about childhood by the river';
      aiGenre.value = 'ballad';
      aiMood.value = 'nostalgic, warm';
      aiVibe.value = 'acoustic, gentle guitar';
      aiVocal.value = 'baritone male';
      aiLength.value = 'medium';
    });

    aiBtn?.addEventListener('click', async () => {
      if (!aiPrompt.value.trim()) {
        alert('Please enter a prompt.');
        aiPrompt.focus();
        return;
      }
      aiStatus.style.display = 'inline-block';
      aiStatus.textContent = 'Generating...';
      aiBtn.disabled = true;

      try {
        const res = await fetch('/api/ai/generate-lyrics', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt: aiPrompt.value,
            genre: aiGenre.value,
            mood: aiMood.value,
            vibe: aiVibe.value,
            vocal: aiVocal.value,
            length: aiLength.value
          })
        });

        const data = await res.json();
        if (data.success) {
          document.querySelector('input[name="title"]').value = data.title || '';
          document.querySelector('textarea[name="lyricsText"]').value = data.lyrics || '';
          aiStatus.textContent = 'Inserted into form âœ“';
        } else {
          aiStatus.textContent = data.message || 'Could not generate lyrics.';
        }
      } catch (err) {
        console.error(err);
        aiStatus.textContent = 'AI connection error.';
      } finally {
        aiBtn.disabled = false;
        setTimeout(() => aiStatus.style.display = 'none', 2500);
      }
    });
  </script>
</body>
</html>

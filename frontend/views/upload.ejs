<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title || 'Upload - SAOCLAO' %></title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/public/css/upload.css">

</head>
<body>
  <header class="header">
    <a class="logo-link" href="/">
      <img src="/public/img/saoclao.png" alt="SAOCLAO" class="logo-img">
    </a>
  </header>
  
  <% if (flash) { %>
    <div class="flash <%= flash.type %>"><%= flash.message %></div>
    <script>setTimeout(() => document.querySelector('.flash').remove(), 3000);</script>
  <% } %>
  
  <main class="container">
    <div class="page-header">
      <h1>T·∫£i l√™n b√†i h√°t c·ªßa b·∫°n</h1>
      <p>ƒê·ªÉ c√≥ ch·∫•t l∆∞·ª£ng t·ªët nh·∫•t, s·ª≠ d·ª•ng ƒë·ªãnh d·∫°ng WAV, FLAC, AIFF ho·∫∑c ALAC. K√≠ch th∆∞·ªõc t·ªëi ƒëa 4GB.</p>
    </div>
    
    <div class="upload-box" id="uploadBox">
      <div class="upload-icon">
        <svg viewBox="0 0 80 80">
          <path d="M40,10 C23,10 10,23 10,40 C10,57 23,70 40,70 C57,70 70,57 70,40 C70,23 57,10 40,10 Z M40,50 L30,40 L35,40 L35,30 L45,30 L45,40 L50,40 Z"/>
        </svg>
      </div>
      <div class="upload-text">
        <h3>K√©o th·∫£ file nh·∫°c v√†o ƒë√¢y ƒë·ªÉ b·∫Øt ƒë·∫ßu</h3>
        <p>ho·∫∑c</p>
      </div>
      <input type="file" id="audioFile" class="file-input" accept=".mp3,.wav,audio/*">
      <button class="choose-btn" onclick="document.getElementById('audioFile').click()">
        Ch·ªçn file
      </button>
    </div>
    
    <form method="post" action="/upload/new" enctype="multipart/form-data" id="detailsForm" class="details-form">
      <input type="file" name="audio" id="hiddenAudio" style="display:none;">
      
      <div class="audio-info" id="audioInfo" style="display:none;">
        <div class="icon">üéµ</div>
        <div class="details">
          <div class="filename" id="audioName"></div>
          <div class="filesize" id="audioSize"></div>
        </div>
      </div>

      <div class="ai-box">
        <div>
          <h3 class="ai-title">AI g·ª£i √Ω b√†i h√°t</h3>
          <p class="ai-desc">Nh·∫≠p m·ªôt √Ω t∆∞·ªüng, ch·ªçn phong c√°ch r·ªìi ƒë·ªÉ AI vi·∫øt l·ªùi.</p>
        </div>
        <div class="form-group">
          <label>√ù t∆∞·ªüng / prompt</label>
          <input type="text" id="aiPrompt" placeholder="VD: M·ªôt bu·ªïi chi·ªÅu m∆∞a nh·ªõ ng∆∞·ªùi y√™u c≈©">
        </div>
        <div class="form-row">
          <div class="form-group half">
            <label>Th·ªÉ lo·∫°i</label>
            <input type="text" id="aiGenre" placeholder="ballad, pop, rap...">
          </div>
          <div class="form-group half">
            <label>Mood</label>
            <input type="text" id="aiMood" placeholder="vui t∆∞∆°i, tr·∫ßm l·∫Øng...">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group half">
            <label>Giai ƒëi·ªáu / vibe</label>
            <input type="text" id="aiVibe" placeholder="chill, s√¥i ƒë·ªông, cinematic...">
          </div>
          <div class="form-group half">
            <label>Tone gi·ªçng</label>
            <input type="text" id="aiVocal" placeholder="nam cao, n·ªØ tr·∫ßm...">
          </div>
        </div>
        <div class="form-group">
          <label>ƒê·ªô d√†i mong mu·ªën</label>
          <input type="text" id="aiLength" placeholder="Ng·∫Øn, v·ª´a, d√†i">
        </div>
        <div class="ai-actions">
          <button type="button" class="btn btn-secondary" id="aiFillDemo">D√°n demo</button>
          <button type="button" class="btn btn-primary" id="aiGenerate">T·∫°o l·ªùi b·∫±ng AI</button>
          <div id="aiStatus" class="ai-status" style="display:none;">ƒêang t·∫°o...</div>
        </div>
      </div>
      
      <div class="form-group">
        <label>T√™n b√†i h√°t <span class="required">*</span></label>
        <input type="text" name="title" required placeholder="Nh·∫≠p t√™n b√†i h√°t">
      </div>
      
      <div class="form-group">
        <label>Ngh·ªá sƒ©</label>
        <input type="text" name="artist" placeholder="T√™n ngh·ªá sƒ©">
      </div>

      <div class="form-row">
        <div class="form-group half">
          <label>Th·ªÉ lo·∫°i (genre)</label>
          <input type="text" name="genres" placeholder="VD: pop, indie, lo-fi">
          <small class="form-hint">Nh·∫≠p nhi·ªÅu gi√° tr·ªã, c√°ch nhau b·ªüi d·∫•u ph·∫©y</small>
        </div>
        <div class="form-group half">
          <label>Tags</label>
          <input type="text" name="tags" placeholder="VD: chill, study, workout">
          <small class="form-hint">Nh·∫≠p nhi·ªÅu gi√° tr·ªã, c√°ch nhau b·ªüi d·∫•u ph·∫©y</small>
        </div>
      </div>

      <div class="form-group">
        <label>Mood</label>
        <input type="text" name="mood" placeholder="VD: happy, sad, energetic">
      </div>

      <div class="form-group">
        <label>Lyrics (text)</label>
        <textarea name="lyricsText" rows="4" placeholder="Nh·∫≠p l·ªùi b√†i h√°t d·∫°ng text th∆∞·ªùng"></textarea>
      </div>

      <div class="form-group">
        <label>Lyrics (LRC)</label>
        <textarea name="lyricsLRC" rows="4" placeholder="[00:12.00] Line 1&#10;[00:25.50] Line 2"></textarea>
        <small class="form-hint">T√πy ch·ªçn, h·ªó tr·ª£ ƒë·ªìng b·ªô ch·ªØ karaoke</small>
      </div>
      
      <div class="form-group">
        <label>·∫¢nh b√¨a</label>
        <div class="image-upload">
          <div class="image-preview empty" id="imagePreview">üñº</div>
          <div class="image-info">
            <p>PNG ho·∫∑c JPG, khuy·∫øn ngh·ªã 3000x3000px.<br>T·ªëi ƒëa 5MB.</p>
            <input type="file" name="cover" id="coverFile" accept="image/*" style="display:none;">
            <button type="button" class="image-btn" onclick="document.getElementById('coverFile').click()">
              Ch·ªçn ·∫£nh
            </button>
          </div>
        </div>
      </div>
      
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="window.location.href='/'">H·ªßy</button>
        <button type="submit" class="btn btn-primary">T·∫£i l√™n</button>
      </div>
    </form>
  </main>
  
  <script>
    const audioFile = document.getElementById('audioFile');
    const hiddenAudio = document.getElementById('hiddenAudio');
    const uploadBox = document.getElementById('uploadBox');
    const detailsForm = document.getElementById('detailsForm');
    const audioInfo = document.getElementById('audioInfo');
    const coverFile = document.getElementById('coverFile');
    const imagePreview = document.getElementById('imagePreview');
    
    audioFile.addEventListener('change', handleAudio);
    
    uploadBox.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadBox.classList.add('dragover');
    });

    uploadBox.addEventListener('dragleave', () => {
      uploadBox.classList.remove('dragover');
    });

    uploadBox.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadBox.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files[0]?.type.startsWith('audio/')) {
        audioFile.files = files;
        handleAudio();
      }
    });
    
    function handleAudio() {
      const file = audioFile.files[0];
      if (file) {
        const dt = new DataTransfer();
        dt.items.add(file);
        hiddenAudio.files = dt.files;
        
        uploadBox.style.display = 'none';
        detailsForm.classList.add('active');
        audioInfo.style.display = 'flex';
        document.getElementById('audioName').textContent = file.name;
        document.getElementById('audioSize').textContent = (file.size / 1024 / 1024).toFixed(1) + ' MB';
      }
    }
    
    coverFile.addEventListener('change', function() {
      const file = this.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          imagePreview.innerHTML = `<img src="${e.target.result}">`;
          imagePreview.classList.remove('empty');
        };
        reader.readAsDataURL(file);
      }
    });

    // AI helper
    const aiBtn = document.getElementById('aiGenerate');
    const aiStatus = document.getElementById('aiStatus');
    const aiPrompt = document.getElementById('aiPrompt');
    const aiGenre = document.getElementById('aiGenre');
    const aiMood = document.getElementById('aiMood');
    const aiVibe = document.getElementById('aiVibe');
    const aiVocal = document.getElementById('aiVocal');
    const aiLength = document.getElementById('aiLength');
    const aiFillDemo = document.getElementById('aiFillDemo');

    aiFillDemo?.addEventListener('click', () => {
      aiPrompt.value = 'M·ªôt ng∆∞·ªùi tr·∫ª nh·ªõ v·ªÅ tu·ªïi th∆° b√™n d√≤ng s√¥ng';
      aiGenre.value = 'ballad';
      aiMood.value = 'ho√†i ni·ªám, ·∫•m √°p';
      aiVibe.value = 'm·ªôc m·∫°c, guitar nh·∫π';
      aiVocal.value = 'nam trung';
      aiLength.value = 'v·ª´a';
    });

    aiBtn?.addEventListener('click', async () => {
      if (!aiPrompt.value.trim()) {
        alert('Vui l√≤ng nh·∫≠p g·ª£i √Ω.');
        aiPrompt.focus();
        return;
      }
      aiStatus.style.display = 'inline-block';
      aiStatus.textContent = 'ƒêang t·∫°o...';
      aiBtn.disabled = true;

      try {
        const res = await fetch('/api/ai/generate-lyrics', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt: aiPrompt.value,
            genre: aiGenre.value,
            mood: aiMood.value,
            vibe: aiVibe.value,
            vocal: aiVocal.value,
            length: aiLength.value
          })
        });

        const data = await res.json();
        if (data.success) {
          document.querySelector('input[name="title"]').value = data.title || '';
          document.querySelector('textarea[name="lyricsText"]').value = data.lyrics || '';
          aiStatus.textContent = 'ƒê√£ ch√®n v√†o form ‚úì';
        } else {
          aiStatus.textContent = data.message || 'Kh√¥ng t·∫°o ƒë∆∞·ª£c l·ªùi.';
        }
      } catch (err) {
        console.error(err);
        aiStatus.textContent = 'L·ªói k·∫øt n·ªëi AI.';
      } finally {
        aiBtn.disabled = false;
        setTimeout(() => aiStatus.style.display = 'none', 2500);
      }
    });
  </script>
</body>
</html>

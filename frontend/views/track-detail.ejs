<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= track.title %> - <%= track.artist %> • SAOCLAO</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="/public/css/track.css">
  <link rel="stylesheet" href="/public/css/lyricspanel.css">
</head>
<body>
  <!-- HEADER -->
  <header class="header">
    <div style="display: flex; align-items: center;">
      <div class="logo">
        <a href="/">
          <img src="/public/img/saoclao.png" alt="SAOCLAO">
        </a>
      </div>
      <nav class="nav-menu">
        <a href="/home" class="nav-link">
          <i class="fa-solid fa-house"></i> Trang chủ
        </a>
        <a href="/playlists" class="nav-link">
          <i class="fa-solid fa-music"></i> Playlist của tôi
        </a>
        <a href="/likes" class="nav-link">
          <i class="fa-solid fa-heart"></i> Đã thích
        </a>
        <a href="/ai" class="nav-link">
          <i class="fa-solid fa-wand-magic-sparkles"></i> AI Generate
        </a>
      </nav>
    </div>
    
    <div class="search-container">
      <div class="search-icon">
        <i class="fa-solid fa-magnifying-glass"></i>
      </div>
      <input type="text" class="search-input" id="searchInput" placeholder="Tìm bài hát, nghệ sĩ...">
      <button class="search-clear" id="searchClear">
        <i class="fa-solid fa-xmark"></i>
      </button>
      <div id="searchDropdown" class="search-dropdown"></div>
    </div>
    
    <div class="header-actions">
      <button class="upload-btn" onclick="window.location.href='/upload'">
        <i class="fa-solid fa-cloud-arrow-up"></i>
        <span class="btn-text">Upload</span>
      </button>
      <a href="/users/<%= user.username %>" style="text-decoration: none;">
        <div class="user-avatar">
          <% if (user.avatarUrl) { %>
            <img src="<%= user.avatarUrl %>" alt="<%= user.username %>">
          <% } else { %>
            <%= user.username.charAt(0).toUpperCase() %>
          <% } %>
        </div>
      </a>
      
      <form method="post" action="/logout" style="display:inline; margin-left: 12px;">
        <button type="submit" class="btn-logout">Đăng xuất</button>
      </form>
    </div>
  </header>

  <div class="container">
    <div class="main-content">
      <!-- HERO SECTION -->
      <div class="hero-section">
        <!-- LEFT: Player Controls -->
        <div class="player-section">
          <div class="track-header">
            <button class="play-button" id="mainPlayBtn">
              <i class="fa-solid fa-play"></i>
            </button>
            <div class="track-thumbnail">
              <img src="<%= track.coverUrl || 'https://images.unsplash.com/photo-1514525253161-7a46d19cd819?w=200' %>" alt="<%= track.title %>">
            </div>
            
            <div class="track-info">
              <h1><%= track.title %></h1>
              <div class="track-artist">
                <% if (track.userId && track.userId.username) { %>
                  <a href="/users/<%= track.userId.username %>">
                    <%= track.artist || 'Unknown Artist' %>
                  </a>
                <% } else { %>
                  <%= track.artist || 'Unknown Artist' %>
                <% } %>
                <% if (track.featuring) { %>
                  <span> ft. <%= track.featuring %></span>
                <% } %>
              </div>
              <% if (track.genres && track.genres.length > 0) { %>
                <div class="track-genres">
                  <% track.genres.slice(0, 3).forEach(genre => { %>
                    <span class="genre-tag">#<%= genre %></span>
                  <% }) %>
                </div>
              <% } %>
            </div>
          </div>
          
          <div class="track-meta">
            <div class="meta-item">
              <i class="fa-regular fa-clock"></i>
              <span><%= new Date(track.createdAt).toLocaleDateString('vi-VN') %></span>
            </div>
          </div>
          
          <!-- WAVEFORM -->
          <div class="waveform-container">
            <div class="waveform" id="waveform"></div>
          </div>
          <div class="time-display">
            <span id="currentTime">0:00</span>
            <span id="duration">0:00</span>
          </div>
          
          <!-- ACTION BUTTONS -->
          <div class="action-buttons">
            <button class="action-btn <%= liked ? 'liked' : '' %>" id="likeBtn" data-track-id="<%= track._id %>" data-liked="<%= liked ? 'true' : 'false' %>">
              <i class="<%= liked ? 'fa-solid fa-heart' : 'fa-regular fa-heart' %>"></i>
              <span id="likeCount"><%= track.likes || 0 %></span>
            </button>
            <button class="action-btn" id="addToQueueBtn">
              <i class="fa-solid fa-list"></i>
              <span>Add to Queue</span>
            </button>
            <button class="action-btn" id="addToPlaylistBtn">
              <i class="fa-solid fa-square-plus"></i>
              <span>Thêm vào playlist</span>
            </button>
            <button class="action-btn" id="shareBtn">
              <i class="fa-solid fa-share"></i>
              <span>Share</span>
            </button>
            
            <!-- LYRICS TOGGLE BUTTON -->
            <button class="action-btn lyric-toggle-btn" id="toggleLyricsBtn" title="Lyrics">
              <i class="fa-solid fa-microphone-lines"></i>
              <span>Lyrics</span>
            </button>
            
            <% if (user.role === 'admin') { %>
              <button class="action-btn admin-approve" id="adminApproveBtn" data-track-id="<%= track._id %>" <% if (track.status === 'approved') { %>disabled<% } %>>
                <i class="fa-solid fa-check"></i>
                <span>Approve</span>
              </button>
              <button class="action-btn admin-reject" id="adminRejectBtn" data-track-id="<%= track._id %>" <% if (track.status === 'rejected') { %>disabled<% } %>>
                <i class="fa-solid fa-xmark"></i>
                <span>Reject</span>
              </button>
              <button class="action-btn admin-delete" id="adminDeleteBtn" data-track-id="<%= track._id %>">
                <i class="fa-solid fa-trash"></i>
                <span>Delete</span>
              </button>
            <% } else { %>
              <button class="action-btn report-btn" id="reportBtn" data-track-id="<%= track._id %>">
                <i class="fa-solid fa-flag"></i>
                <span>Report</span>
              </button>
            <% } %>
          </div>

          <!-- LYRICS PANEL -->
          <div class="lyrics-panel" id="lyricsPanel" hidden>
            <div class="lyrics-header">
              <div class="lyrics-title">
                <i class="fa-solid fa-microphone-lines"></i>
                <span>Lyrics</span>
              </div>
              <div class="lyrics-tools">
                <button class="lyrics-btn small" id="closeLyricsBtn" title="Close">
                  <i class="fa-solid fa-xmark"></i>
                </button>
              </div>
            </div>
            <div class="lyrics-body">
              <div id="lyricsLines" class="lyrics-lines">
                <div class="lyrics-empty">Đang tải lyric…</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- RIGHT: Cover/MV Section -->
        <div class="cover-section">
          <% if (track.videoUrl) { %>
            <div class="mv-player-container">
              <video 
                id="mvPlayer" 
                muted
                loop
                playsinline
                poster="<%= track.coverUrl || '' %>"
                class="mv-video"
              >
                <source src="<%= track.videoUrl %>" type="video/mp4">
              </video>
              <div class="mv-badge">
                <i class="fa-solid fa-video"></i>
                <span>MV</span>
              </div>
            </div>
          <% } else { %>
            <div class="cover-image">
              <img src="<%= track.coverUrl || 'https://images.unsplash.com/photo-1514525253161-7a46d19cd819?w=500' %>" alt="<%= track.title %>">
            </div>
          <% } %>
          
          <div class="stats">
            <div class="stat-item">
              <span class="stat-value" id="playCount"><%= track.playCount || 0 %></span>
              <span class="stat-label">Plays</span>
            </div>
            <div class="stat-item">
              <span class="stat-value"><%= track.likes || 0 %></span>
              <span class="stat-label">Likes</span>
            </div>
            <div class="stat-item">
              <span class="stat-value"><%= comments.length %></span>
              <span class="stat-label">Comments</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- COMMENTS SECTION -->
      <div class="comments-section">
        <div class="comments-header">
          <h2 class="comments-title">Comments (<%= comments.length %>)</h2>
        </div>
        
        <div class="comment-input-section">
          <div class="user-avatar">
            <% if (user.avatarUrl) { %>
              <img src="<%= user.avatarUrl %>" alt="<%= user.username %>">
            <% } else { %>
              <%= user.username.charAt(0).toUpperCase() %>
            <% } %>
          </div>
          <div class="comment-input-wrapper">
            <input type="text" class="comment-input" placeholder="Write a comment..." id="commentInput">
            <button class="comment-submit" id="submitComment">
              <i class="fa-solid fa-paper-plane"></i>
            </button>
          </div>
        </div>
        
        <div class="comments-list" id="commentsList">
          <% if (comments.length > 0) { %>
            <% comments.forEach(comment => { %>
              <div class="comment" id="comment-<%= comment._id %>" data-comment-id="<%= comment._id %>">
                <div class="comment-avatar">
                  <% if (comment.userId.avatarUrl) { %>
                    <img src="<%= comment.userId.avatarUrl %>" alt="<%= comment.userId.username %>">
                  <% } else { %>
                    <%= comment.userId.username.charAt(0).toUpperCase() %>
                  <% } %>
                </div>
                <div class="comment-content">
                  <div class="comment-header">
                    <a href="/users/<%= comment.userId.username %>" class="comment-author" style="text-decoration: none; color: var(--text-primary); transition: color 0.2s;">
                      <%= comment.userId.username %>
                    </a>
                    <span class="comment-time"><%= new Date(comment.createdAt).toLocaleString('vi-VN') %></span>
                  </div>
                  <p class="comment-text"><%= comment.text %></p>
                  <div class="comment-actions">
                    <button class="comment-action comment-like" data-comment-id="<%= comment._id %>" data-liked="<%= comment.liked ? 'true' : 'false' %>">
                      <i class="<%= comment.liked ? 'fa-solid fa-heart' : 'fa-regular fa-heart' %>"></i>
                      <span class="comment-like-count"><%= comment.likes || 0 %></span>
                    </button>
                    <% const ownerCheck = comment.isOwner || (comment.userId && comment.userId._id && comment.userId._id.toString() === user.id.toString()); %>
                    <% if (ownerCheck) { %>
                      <button class="comment-action comment-edit" data-comment-id="<%= comment._id %>" title="Sửa bình luận">
                        <i class="fa-regular fa-pen-to-square"></i>
                      </button>
                      <button class="comment-action comment-delete" data-comment-id="<%= comment._id %>" title="Xóa bình luận">
                        <i class="fa-solid fa-trash"></i>
                      </button>
                    <% } else if (user.role === 'admin') { %>
                      <button class="comment-action admin-delete-comment" data-comment-id="<%= comment._id %>">
                        <i class="fa-solid fa-trash"></i>
                        <span>Delete</span>
                      </button>
                    <% } %>
                  </div>
                </div>
              </div>
            <% }) %>
          <% } else { %>
            <div class="empty-comments">
              <p>No comments yet. Be the first to comment!</p>
            </div>
          <% } %>
        </div>
      </div>
    </div>

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <!-- Related Tracks Section -->
      <div class="sidebar-section">
        <div class="sidebar-header">
          <h3 class="sidebar-title">Bài hát liên quan</h3>
          <a href="#" class="view-all">View all</a>
        </div>
        <div id="relatedTracks">
          <% if (typeof relatedTracks !== 'undefined' && relatedTracks.length > 0) { %>
            <% relatedTracks.slice(0, 5).forEach(relatedTrack => { %>
              <div class="related-track" onclick="window.location.href='/track/<%= relatedTrack._id %>'">
                <div class="related-track-cover">
                  <img src="<%= relatedTrack.coverUrl || 'https://images.unsplash.com/photo-1514525253161-7a46d19cd819?w=200' %>" alt="<%= relatedTrack.title %>">
                  <div class="related-track-play">
                    <i class="fa-solid fa-play"></i>
                  </div>
                </div>
                <div class="related-track-info">
                  <div class="related-track-title"><%= relatedTrack.title %></div>
                  <div class="related-track-artist"><%= relatedTrack.artist || 'Unknown Artist' %></div>
                  <div class="related-track-stats">
                    <span class="related-track-stat">
                      <i class="fa-solid fa-play"></i>
                      <%= relatedTrack.plays || 0 %>
                    </span>
                    <span class="related-track-stat">
                      <i class="fa-solid fa-heart"></i>
                      <%= relatedTrack.likes || 0 %>
                    </span>
                  </div>
                </div>
              </div>
            <% }) %>
          <% } else { %>
            <p style="color: var(--text-secondary); font-size: 13px; text-align: center; padding: 20px 0;">
              Không có bài hát liên quan
            </p>
          <% } %>
        </div>
      </div>

      <!-- In Playlists Section -->
      <div class="sidebar-section">
        <div class="sidebar-header">
          <h3 class="sidebar-title">In Playlists</h3>
          <a href="/playlists" class="view-all">View all</a>
        </div>
        <div id="inPlaylists">
          <% if (typeof playlists !== 'undefined' && playlists.length > 0) { %>
            <% playlists.slice(0, 3).forEach(playlist => { %>
              <a href="/playlists/<%= playlist._id %>" class="playlist-item">
                <div class="playlist-cover">
                  <img src="<%= playlist.coverUrl || 'https://images.unsplash.com/photo-1470225620780-dba8ba36b745?w=200' %>" alt="<%= playlist.name %>">
                </div>
                <div class="playlist-info">
                  <div class="playlist-name"><%= playlist.name %></div>
                  <div class="playlist-author"><%= playlist.userId?.username || 'Unknown' %></div>
                </div>
              </a>
            <% }) %>
          <% } else { %>
            <p style="color: var(--text-secondary); font-size: 13px; text-align: center; padding: 20px 0;">
              Chưa có playlist nào
            </p>
          <% } %>
        </div>
      </div>
    </aside>
  </div>
  
  <!-- MUSIC PLAYER - Fixed Bottom -->
  <div class="music-player" id="musicPlayer">
    <div class="player-wrapper">
      <div class="player-left">
        <div class="player-thumb" id="playerThumb"></div>
        <div class="player-info">
          <div class="player-title" id="playerTitle">Track Title</div>
          <div class="player-artist" id="playerArtist">Artist</div>
        </div>
      </div>
      
      <div class="player-center">
        <div class="player-buttons">
          <button class="control-btn" id="shuffleBtn" title="Shuffle">
            <i class="fa-solid fa-shuffle"></i>
          </button>
          <button class="control-btn" id="prevBtn" title="Previous">
            <i class="fa-solid fa-backward-step"></i>
          </button>
          <button class="control-btn play" id="playPauseBtn">
            <i class="fa-solid fa-play"></i>
          </button>
          <button class="control-btn" id="nextBtn" title="Next">
            <i class="fa-solid fa-forward-step"></i>
          </button>
          <button class="control-btn" id="repeatBtn" title="Repeat">
            <i class="fa-solid fa-repeat"></i>
          </button>
        </div>
        <div class="player-progress-wrapper">
          <span class="time" id="bottomCurrentTime">0:00</span>
          <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <span class="time" id="bottomDuration">0:00</span>
        </div>
      </div>
      
      <div class="player-right">
        <div class="volume-control">
          <i class="fa-solid fa-volume-high volume-icon" id="volumeIcon"></i>
          <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="70">
        </div>
        <button class="queue-toggle" id="playerLikeBtn" data-liked="<%= liked ? 'true' : 'false' %>" title="Đã thích">
          <i id="playerLikeIcon" class="<%= liked ? 'fa-solid fa-heart' : 'fa-regular fa-heart' %>"></i>
        </button>
        <button class="queue-toggle" id="queueBtn" title="Queue">
          <i class="fa-solid fa-list"></i>
          <span class="queue-count" id="queueCount">0</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Queue Panel -->
  <div class="queue-panel" id="queuePanel">
    <div class="queue-header">
      <div style="display:flex; align-items:center; gap:10px;">
        <button class="queue-close" onclick="player.toggleQueuePanel()" title="Đóng">
          <i class="fa-solid fa-chevron-left"></i>
        </button>
        <h3 class="queue-title">Hàng đợi</h3>
      </div>
      <button class="queue-clear" onclick="player.clearQueue()">Xóa tất cả</button>
    </div>
    <div class="queue-list" id="queueList"></div>
  </div>

  <!-- Report Modal -->
  <div class="modal" id="reportModal">
    <div class="modal-overlay" onclick="closeReportModal()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h3>Báo cáo bài hát</h3>
        <button class="modal-close" onclick="closeReportModal()">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="modal-body">
        <p style="color: var(--text-secondary); margin-bottom: 20px;">
          Vui lòng chọn lý do báo cáo bài hát này
        </p>
        <div class="report-reasons">
          <label class="report-reason-item">
            <input type="radio" name="reportReason" value="copyright">
            <div class="reason-content">
              <i class="fa-solid fa-copyright"></i>
              <div>
                <div class="reason-title">Vi phạm bản quyền</div>
                <div class="reason-desc">Bài hát này vi phạm bản quyền của tôi hoặc người khác</div>
              </div>
            </div>
          </label>
          
          <label class="report-reason-item">
            <input type="radio" name="reportReason" value="inappropriate">
            <div class="reason-content">
              <i class="fa-solid fa-ban"></i>
              <div>
                <div class="reason-title">Nội dung không phù hợp</div>
                <div class="reason-desc">Chứa nội dung bạo lực, khiêu dâm hoặc phân biệt đối xử</div>
              </div>
            </div>
          </label>
          
          <label class="report-reason-item">
            <input type="radio" name="reportReason" value="spam">
            <div class="reason-content">
              <i class="fa-solid fa-circle-exclamation"></i>
              <div>
                <div class="reason-title">Spam hoặc lừa đảo</div>
                <div class="reason-desc">Bài hát spam hoặc có mục đích lừa đảo</div>
              </div>
            </div>
          </label>
          
          <label class="report-reason-item">
            <input type="radio" name="reportReason" value="misleading">
            <div class="reason-content">
              <i class="fa-solid fa-triangle-exclamation"></i>
              <div>
                <div class="reason-title">Thông tin sai lệch</div>
                <div class="reason-desc">Tiêu đề, tác giả hoặc thông tin không chính xác</div>
              </div>
            </div>
          </label>
          
          <label class="report-reason-item">
            <input type="radio" name="reportReason" value="other">
            <div class="reason-content">
              <i class="fa-solid fa-ellipsis"></i>
              <div>
                <div class="reason-title">Lý do khác</div>
                <div class="reason-desc">Vấn đề khác không nằm trong các danh mục trên</div>
              </div>
            </div>
          </label>
        </div>
        
        <div style="margin-top: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px;">
            Mô tả chi tiết (không bắt buộc)
          </label>
          <textarea 
            id="reportDescription" 
            placeholder="Cung cấp thêm thông tin về báo cáo của bạn..."
            style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-family: 'Inter', sans-serif; min-height: 100px; resize: vertical;"
          ></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeReportModal()">Hủy</button>
        <button class="btn-submit" id="submitReport">Gửi báo cáo</button>
      </div>
    </div>
  </div>

  <!-- Playlist Modal -->
  <div class="modal" id="playlistModal">
    <div class="modal-overlay" onclick="closePlaylistModal()"></div>
    <div class="modal-content wide">
      <div class="modal-header">
        <h3>Thêm vào playlist</h3>
        <button class="modal-close" onclick="closePlaylistModal()">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="modal-body">
        <div id="playlistLoading" style="color: var(--text-secondary); margin-bottom: 12px;">Đang tải playlist...</div>
        <div id="playlistError" style="color: #ff7675; margin-bottom: 12px; display: none;">Không thể tải playlist.</div>
        <div class="playlist-list" id="playlistList"></div>
        <div style="margin-top: 12px; font-size: 13px; color: var(--text-secondary);">
          Bạn có thể tạo playlist mới tại <a href="/playlists" style="color: #37ff9f; font-weight: 600;">Playlist của tôi</a>.
        </div>
      </div>
    </div>
  </div>
  
  <audio id="audioPlayer"></audio>
  
  <script src="/public/js/player.js"></script>
  <script src="/public/js/detail.js"></script>
 
</body>
</html>
